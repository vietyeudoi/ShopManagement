@model Sieu_Thi_Mini.Models.Customer

@{
    Layout = "_LayoutCustomer";
    ViewData["Title"] = "Trang cá nhân";
}

<h2>Hồ sơ cá nhân</h2>
<p class="text-muted">Quản lý thông tin cá nhân</p>

<div class="mb-3">
    <button type="button" class="btn btn-warning" id="btnEdit">Chỉnh sửa</button>
    <button type="button" class="btn btn-primary d-none" id="btnSave">Lưu</button>
    <button type="button" class="btn btn-secondary d-none" id="btnCancel">Huỷ</button>
</div>

<form method="post" id="profileForm">
    <input type="hidden" asp-for="CustomerId" />

    <!-- ========== THÔNG TIN ========== -->
    <h5>Thông tin cá nhân</h5>
    <div class="mb-2">
        <label>Họ và tên</label>
        <input asp-for="FullName" class="form-control editable" disabled />
    </div>

    <div class="mb-2">
        <label>Số điện thoại</label>
        <input asp-for="Phone" class="form-control editable" disabled />
    </div>

    <hr />

    <!-- ========== ĐỊA CHỈ ========== -->
    <h5>Danh sách địa chỉ</h5>

    <div id="addressList">
        @for (int i = 0; i < Model.ListAdress.Count; i++)
        {
            <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center"
                 id="addr-@i"
                 data-address="@Model.ListAdress[i]">

                <span>@Model.ListAdress[i]</span>

                <!-- 🔥 INPUT ẨN GIỮ ĐỊA CHỈ CŨ -->
                <input type="hidden"
                       name="ListAdress"
                       value="@Model.ListAdress[i]" />

                <button type="button"
                        class="btn btn-sm btn-outline-danger btnRemove d-none"
                        data-index="@i">
                    ❌
                </button>
            </div>

        }
    </div>


    <button type="button" class="btn btn-secondary mt-2 d-none" id="btnAdd">
        Thêm địa chỉ
    </button>

    <!-- ========== ADD ADDRESS ========== -->
    <div class="mt-3 border-top pt-3 d-none" id="divAdd">
        <h6>Thêm địa chỉ mới</h6>

        <select id="province" class="form-select mb-2 editable" disabled>
            <option value="">-- Chọn Tỉnh --</option>
        </select>

        <select id="district" class="form-select mb-2 editable" disabled>
            <option value="">-- Chọn Huyện --</option>
        </select>

        <select id="ward" class="form-select mb-2 editable" disabled>
            <option value="">-- Chọn Xã --</option>
        </select>

        <input type="text"
               id="txtFullAddress"
               class="form-control mb-2"
               placeholder="Địa chỉ đầy đủ"
               readonly />

        <button type="button" class="btn btn-outline-secondary" id="btnHideAdd">
            Huỷ thêm
        </button>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const province = document.getElementById("province");
        const district = document.getElementById("district");
        const ward = document.getElementById("ward");
        const txtFullAddress = document.getElementById("txtFullAddress");

        const btnEdit = document.getElementById("btnEdit");
        const btnSave = document.getElementById("btnSave");
        const btnCancel = document.getElementById("btnCancel");
        const btnAdd = document.getElementById("btnAdd");
        const btnHideAdd = document.getElementById("btnHideAdd");
        const divAdd = document.getElementById("divAdd");
        const form = document.getElementById("profileForm");

        /* ===== LOAD PROVINCE ===== */
        axios.get("https://provinces.open-api.vn/api/p/")
            .then(res => {
                res.data.forEach(p => {
                    province.innerHTML +=
                        `<option value="${p.code}">${p.name}</option>`;
                });
            });

        province.onchange = function () {
            district.innerHTML = `<option value="">-- Chọn Huyện --</option>`;
            ward.innerHTML = `<option value="">-- Chọn Xã --</option>`;
            txtFullAddress.value = "";

            if (!this.value) return;

            axios.get(`https://provinces.open-api.vn/api/p/${this.value}?depth=2`)
                .then(res => {
                    res.data.districts.forEach(d => {
                        district.innerHTML +=
                            `<option value="${d.code}">${d.name}</option>`;
                    });
                });
        };

        district.onchange = function () {
            ward.innerHTML = `<option value="">-- Chọn Xã --</option>`;
            txtFullAddress.value = "";

            if (!this.value) return;

            axios.get(`https://provinces.open-api.vn/api/d/${this.value}?depth=2`)
                .then(res => {
                    res.data.wards.forEach(w => {
                        ward.innerHTML +=
                            `<option value="${w.name}">${w.name}</option>`;
                    });
                });
        };

        ward.onchange = function () {
            const p = province.options[province.selectedIndex]?.text;
            const d = district.options[district.selectedIndex]?.text;
            if (p && d && ward.value) {
                txtFullAddress.value = `${ward.value}, ${d}, ${p}`;
            }
        };

        /* ===== EDIT ===== */
    btnEdit.onclick = function () {

        // Cho sửa input
        document.querySelectorAll(".editable").forEach(e => e.disabled = false);

        // Hiện nút xoá địa chỉ
        document.querySelectorAll(".btnRemove").forEach(b => {
            b.classList.remove("d-none");
        });

        btnEdit.classList.add("d-none");
        btnSave.classList.remove("d-none");
        btnCancel.classList.remove("d-none");
        btnAdd.classList.remove("d-none");
    };


        btnAdd.onclick = () => divAdd.classList.remove("d-none");
        btnHideAdd.onclick = () => divAdd.classList.add("d-none");
        btnCancel.onclick = () => location.reload();

        /* ===== XOÁ ĐỊA CHỈ ===== */
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("btnRemove")) {
                e.target.closest("[data-address]").remove();
            }
        });

        /* ===== SUBMIT ===== */
    btnSave.onclick = function () {

        if (txtFullAddress.value) {

            const wrapper = document.createElement("div");

            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "ListAdress";
            input.value = txtFullAddress.value;

            wrapper.appendChild(input);
            form.appendChild(wrapper);
        }

        form.submit();
    };

    });

        document.addEventListener("click", function (e) {
        if (e.target.classList.contains("btnRemove")) {

            if (!confirm("Xoá địa chỉ này?")) return;

            const index = e.target.dataset.index;

            fetch('/Customer/Profile/DeleteAddress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `index=${index}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`addr-${index}`).remove();
                } else {
                    alert("Xoá thất bại");
                }
            });
        }
    });
</script>
